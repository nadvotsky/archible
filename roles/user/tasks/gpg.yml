- name: Mask unnecessary GnuPG services
  ansible.builtin.import_role:
    name: common
  vars:
    _common_services:
      defaults:
        - user
        - mask
      targets:
        keyboxd.socket:
        keyboxd.service:
        gpg-agent-browser.socket:
        gpg-agent-extra.socket:

- name: Stop GnuPG services
  ansible.builtin.import_role:
    name: common
  vars:
    _common_services:
      defaults:
        - user
        - stop
      targets:
        gpg-agent.service:
        gpg-agent.socket:
        dirmngr.service:
        dirmngr.socket:

- name: Configure GnuPG
  ansible.builtin.import_role:
    name: common
  vars:
    _common_install:
      defaults:
        wipe: true
        base: "{{ users.user.home }}"
        dirmode: "0700"
        filemode: "0600"
      targets:
        .gnupg/common.conf:
          content: |
            #
            # common.conf - common defaults for all components.
            #
        .gnupg/dirmngr.conf:
          template: gpg/dirmngr.conf.j2
        .gnupg/gpg.conf:
          template: gpg/gpg.conf.j2
        .gnupg/gpg-agent.conf:
          template: gpg/gpg-agent.conf.j2

- name: Enable GnuPG services
  ansible.builtin.import_role:
    name: common
  vars:
    _common_services:
      defaults:
        - user
        - enable
      targets:
        gpg-agent.service:
        gpg-agent.socket:
        dirmngr.service:
        dirmngr.socket:

- name: Retrieve the keyring from the persist
  block:
    - name: Retrieve the keyring from the persist
      ansible.builtin.import_role:
        name: common
      vars:
        _common_persist: gpg/keyring

    - name: Save the exported variable
      ansible.builtin.set_fact:
        __gpg_keyring: "{{ _common_persist_invocation }}"

- name: Push the keyring from the persist
  tags:
    - user-gpg-push
  when: __gpg_keyring.content is defined
  block:
    - name: Push the private keys explicitly to GnuPG
      ansible.builtin.import_role:
        name: common
      vars:
        _common_push:
          defaults:
            base: "{{ users.user.home }}"
            dirmode: "0700"
            filemode: "0600"
          targets:
            gpg/keyring:
              shell: gpg --batch --import-options restore --import -
            gpg/private-keys:
              archive: .gnupg/private-keys-v1.d
            gpg/unattended-keys:
              file: ".gnupg/{{ security.gpg.metadata }}"

    - name: Retrieve keys metadata
      ansible.builtin.import_role:
        name: common
      vars:
        _common_gpg: ~

    - name: Import ownertrust to GnuPG
      vars:
        __stdin: >-
          {%- set _acc = [] -%}
          {%- for _key in _common_gpg_invocation.values() -%}
            {%- set _ = _acc.append("{}:6:".format(_key.fingerprint)) -%}
          {%- endfor -%}
          {{ _acc | join("\n") }}
      ansible.builtin.command:
        argv:
          - gpg
          - --import-ownertrust
        stdin: "{{ __stdin | replace('\\n', '\n') }}"
      register: __gpg_import_ownertrust_invocation
      changed_when: __gpg_import_ownertrust_invocation.rc == 0

- name: Generate new keyring
  tags:
    - user-gpg-generate
  when: __gpg_keyring.content is not defined
  vars:
    __regex_fingerprint: .*KEY_CREATED.*([0-9-A-Z]{40})
    __regex_keygrip: fpr:+{}:+\sgrp:+(\w+)
    __subkeys: "{{ gpg | dict2items | map(attribute='value.subkeys') | map('dict2items') | flatten }}"
    __subkey_to_master: >-
      {%- set _assoc = {} -%}
      {%- for _master, _subdicts in gpg.items() -%}
        {%- for _subkey in _subdicts.subkeys.keys() -%}
          {%- set _ = _assoc.update({_subkey: _master}) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ _assoc }}
  block:
    - name: Generate master keys
      ansible.builtin.command:
        cmd: >-
          gpg
          --batch
          --status-fd 1
          --generate-key
        stdin: |-
          Key-Type: {{ item.algo }}
          Key-{{ 'Curve' if item.algo.startswith(('ec', 'ed')) else 'Length' }}: {{ item.hint }}
          Key-Usage: cert
          Name-Real: {{ item.name }}
          Name-Comment: {{ item.comment }}
          Name-Email: {{ item.email }}
          Expire-Date: {{ item.expire }}
          Creation-Date: {{ now(utc=true, fmt='%Y') }}-01-01
          Passphrase: {{ item.password }}
          Keyserver: {{ security.gpg.keyserver }}
          Preferences: {{
            (
              ['OCB'] + security.gpg.hash + security.gpg.cipher + security.gpg.compression
            ) | join(' ')
          }}
      register: __gpg_master_invocation
      changed_when: __gpg_master_invocation.rc == 0
      loop: "{{ gpg | dict2items | map(attribute='value.master') }}"

    - name: Extract fingerprints of the master keys
      ansible.builtin.set_fact:
        __keys: >-
          {%- set _acc = {} -%}
          {%- for _master, _invocation in gpg.keys() | zip(__gpg_master_invocation.results) -%}
            {% set _ = _acc.update({
                _master: {
                  'fingerprint': _invocation.stdout | regex_search(__regex_fingerprint, '\\1') | first,
                },
            }) %}
          {%- endfor -%}
          {{ _acc }}

    - name: Generate subkeys
      ansible.builtin.command:
        cmd: >-
          gpg
          --batch
          --status-fd 1
          --pinentry-mode loopback
          --passphrase-fd 0
          --faked-system-time {{ '{}0101T000000Z!'.format(now(utc=true, fmt='%Y')) }}
          --quick-add-key {{ __keys[__subkey_to_master[item.key]].fingerprint }}
          {{
            [item.value.hint, item.value.algo] | reject("none") | join("/")
            if item.value.algo.startswith(("ec", "ed")) else
            [item.value.algo, item.value.hint] | join("")
          }}
          {{ item.value.type }}
          {{ gpg[__subkey_to_master[item.key]].master.expire }}
        stdin: "{{ gpg[__subkey_to_master[item.key]].master.password }}"
      register: __gpg_subkeys_invocation
      changed_when: __gpg_subkeys_invocation.rc == 0
      loop: "{{ __subkeys }}"

    - name: Get keyring information
      ansible.builtin.command:
        argv:
          - gpg
          - --batch
          - --with-colons
          - --with-keygrip
          - --list-keys
      register: __gpg_keyring_invocation
      changed_when: __gpg_keyring_invocation.rc == 0

    - name: Extract keygrip and fingerprint for each created key and subkey
      ansible.builtin.set_fact:
        __keys: >-
          {%- for _master in gpg.keys() -%}
            {%- set _ = __keys[_master].__setitem__(
              'keygrip',
              __gpg_keyring_invocation.stdout
                | regex_search(__regex_keygrip.format(__keys[_master].fingerprint), '\\1')
                | first,
            ) -%}
          {%- endfor -%}
          {#--#}
          {%- for _subkey, _invocation in __subkeys | map(attribute='key') | zip(__gpg_subkeys_invocation.results) -%}
            {%- set _subkey_fingerprint = _invocation.stdout | regex_search(__regex_fingerprint, '\\1') | first -%}
            {%- set _ = __keys.update({
              _subkey: {
                'fingerprint': _subkey_fingerprint,
                'keygrip': __gpg_keyring_invocation.stdout
                  | regex_search(__regex_keygrip.format(_subkey_fingerprint), '\\1')
                  | first,
              },
            }) -%}
          {%- endfor -%}
          {{ __keys }}

    - name: Apply ssh priority to subkeys
      ansible.builtin.command:
        argv:
          - gpg-connect-agent
          - --unbuffered
          - "KEYATTR {{ __keys[item.key].keygrip }} Use-for-ssh: {{ item.value.priority }}"
          - /bye
      register: __gpg_keyattr_invocation
      changed_when: __gpg_keyattr_invocation.rc == 0
      loop: "{{ __subkeys | selectattr('value.priority', 'defined') }}"

    - name: Render keys metadata into the file
      vars:
        __metadata: "{{ users.user.home }}/.gnupg/{{ security.gpg.metadata }}"
      block:
        - name: Render keys metadata into the file
          ansible.builtin.shell:
            cmd: >-
              {{ base64.shell_decode }} > "{{ __metadata }}"
            stdin: "{{ __keys | to_nice_json | b64encode }}"
          register: __metadata_shell_invocation
          changed_when: __metadata_shell_invocation.rc == 0

        - name: Ensure keys metadata file permissions is set
          ansible.builtin.file:
            path: "{{ __metadata }}"
            mode: "0600"
