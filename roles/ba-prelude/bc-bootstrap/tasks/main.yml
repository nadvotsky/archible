---
- name: Configure bootstrap dependencies
  tags: prelude-bootstrap-deps
  block:
    - name: Ensure that pacstrap (arch-install-scripts) and mkpasswd (whois) are available
      ansible.builtin.shell:
        cmd: command -v pacstrap && command -v mkpasswd
      register: _ba_deps_invocation
      changed_when: false
      failed_when: _ba_deps_invocation.rc != 0

- name: Configure base system
  tags: prelude-bootstrap-main
  block:
    - name: Bootstrap base system with pacstrap
      become: true
      ansible.builtin.command:
        argv: "{{ _bc_pacstrap_cmdline | reject('none') }}"
      vars:
        _bc_pacstrap_cmdline:
          - pacstrap
          - -M
          - -K
          - "{{ ba_mount_point }}"
          - base
          - iptables-nft
          #
          # Ansible, mkpasswd, and packaging.
          #
          - python
          - sudo
          - whois
          - reflector
          #
          # Networking.
          #
          - "{{ 'iwd' if ba_wireless is true else none }}"
      register: _bc_pacstrap_invocation
      changed_when: _bc_pacstrap_invocation.rc == 0

- name: Configure systemd-firstboot
  tags: prelude-bootstrap-firstboot
  block:
    - name: Process user password via the yescrypt KDF
      ansible.builtin.command:
        argv:
          - mkpasswd
          - --method=yescrypt
          - --stdin
        stdin: "{{ bc_root_password }}"
      register: _bc_mkpasswd_invocation
      changed_when: _bc_mkpasswd_invocation.rc == 0

    - name: Prepare system via systemd-firstboot
      become: true
      ansible.builtin.command:
        argv:
          - systemd-firstboot
          - --root={{ ba_mount_point }}
          - --locale={{ ba_locale }}
          - --keymap={{ bc_keymap }}
          - --timezone={{ bc_timezone }}
          - --hostname={{ ba_hostname }}
          - --setup-machine-id
          - --root-password-hashed={{ _bc_mkpasswd_invocation.stdout }}
          - --force
      register: _bc_firstboot_invocation
      changed_when: _bc_firstboot_invocation.rc == 0
