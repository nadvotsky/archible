---
- name: Configure bootstrap dependencies
  tags: prelude-bootstrap-deps
  block:
    - name: Ensure that pacstrap (arch-install-scripts) and mkpasswd (whois) are available
      ansible.builtin.shell:
        cmd: command -v pacstrap && command -v mkpasswd
      register: _ba_deps_invocation
      changed_when: false
      failed_when: _ba_deps_invocation.rc != 0

- name: Configure base system
  tags: prelude-bootstrap-main
  block:
    - name: Bootstrap base system with pacstrap
      become: true
      ansible.builtin.command:
        argv:
          - pacstrap
          - -M
          - -K
          - "{{ ba_mount_point }}"
          - base
          - iptables-nft
          - util-linux
          #
          # Kernel.
          #
          - linux
          - linux-firmware
          #
          # Ansible, mkpasswd, and packaging.
          #
          - python
          - sudo
          - whois
          - reflector
      register: _bc_pacstrap_invocation
      changed_when: _bc_pacstrap_invocation.rc == 0

- name: Configure fstab
  tags: prelude-bootstrap-fstab
  block:
    - name: Generate fstab via genfstab
      become: true
      ansible.builtin.shell:
        cmd: >-
          genfstab -t PARTUUID "{{ ba_mount_point }}" > "{{ ba_mount_point }}/etc/fstab"
      register: _bc_genfstab_invocation
      changed_when: _bc_genfstab_invocation.rc == 0

    - name: Modify mount options
      become: true
      ansible.builtin.replace:
        path: "{{ ba_mount_point }}/etc/fstab"
        regexp: "\
          (?P<spec>[^\\s]+)\\s+\
          (?P<file>{{ item.file }})\\s+\
          (?P<vfstype>\\w+)\\s+\
          (?P<mntops>[\\w=,-]+)\\s+\
          (?P<freq>[01])\\s+\
          (?P<passno>\\d+)\\s*\
          "
        replace: >
          \g<spec>
          \g<file>
          \g<vfstype>
          {{ item.mntops }}
          \g<freq>
          \g<passno>
        mode: "0644"
        owner: 0
        group: 0
      loop:
        - file: /
          mntops: "{{ bc_mountopts_root }}"
        - file: /boot
          mntops: "{{ bc_mountopts_efi }}"
      register: _bc_replace_invocation
      failed_when: _bc_replace_invocation is not changed

- name: Configure systemd-firstboot
  tags: prelude-bootstrap-firstboot
  block:
    - name: Process user password via the yescrypt KDF
      ansible.builtin.command:
        argv:
          - mkpasswd
          - --method=yescrypt
          - --stdin
        stdin: "{{ bc_root_password }}"
      register: _bc_mkpasswd_invocation
      changed_when: _bc_mkpasswd_invocation.rc == 0

    - name: Prepare system via systemd-firstboot
      become: true
      ansible.builtin.command:
        argv:
          - systemd-firstboot
          - --root={{ ba_mount_point }}
          - --locale={{ ba_locale }}
          - --keymap={{ bc_keymap }}
          - --timezone={{ bc_timezone }}
          - --hostname={{ ba_hostname }}
          - --setup-machine-id
          - --root-password-hashed={{ _bc_mkpasswd_invocation.stdout }}
          - --force
      register: _bc_firstboot_invocation
      changed_when: _bc_firstboot_invocation.rc == 0
