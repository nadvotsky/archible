{%- set mod = "SUPER" -%}
{%- set alt = "SUPER_SHIFT" -%}

{%- set space_normal = (env_space_normal * env_scale) | round | int -%}
{%- set space_big = (env_space_big * env_scale) | round | int -%}
{%- set gaps = (env_space_big * 2 * env_scale) | round | int -%}

{%- set accent = "rgb({})".format(env_accent[1:]) -%}
{%- set background = "rgb({})".format(env_background[1:]) -%}
{%- set foreground = "rgb({})".format(env_foreground[1:]) -%}
{%- set active = "rgb({})".format(env_active[1:]) -%}
{%- set inactive = "rgb({})".format(env_inactive[1:]) -%}

{%- set font = "{} SemiBold".format(env_font_sans_serif) -%}
{%- set px_to_pt = env_ethalon / 72 -%}
{%- set font_size_px = ((env_font_size - env_font_offset) * env_scale) | round -%}
{%- set font_size = (font_size_px / px_to_pt) | round | int -%}

{#
    Allocating F5..F8, F1..F4 for the first monitor,
    and allocating F9..F12 for the second monitor.

    All of them can be used, or just some of them if there are less monitors or workspaces.
#}
{%- set monitors_keybind = [
    (range(5, 8+1) | list) + (range(1, 4+1) | list),
    range(9, 12+1) | list,
] -%}

#
# Monitors configuration.
#
monitor = Unknown-1, disabled
{{- "\n" -}}
{%- for mon in env_monitors -%}
    {%- set orientation = "down" if env_monitors_stack == "vertical" else "auto-right" -%}
    monitor = {{ mon.wayland }}, {{ mon.width }}x{{ mon.height }}@{{ mon.refresh }}, {{ orientation }}, 1{{ "\n" }}
{%- endfor -%}
{{- "\n\n" -}}

#
# Enviromental variables.
#
env = XDG_SESSION_TYPE, wayland
env = GBM_BACKEND, nvidia-drm
env = GDK_BACKEND, wayland
env = SDL_VIDEODRIVER, wayland
env = QT_QPA_PLATFORM, wayland
env = MOZ_ENABLE_WAYLAND, 1
env = KITTY_ENABLE_WAYLAND, 1
env = ELECTRON_OZONE_PLATFORM_HINT, wayland
env = _JAVA_AWT_WM_NONREPARENTING, 1

#
# Autostart before scaling is set.
#
exec-once = waybar
exec-once = mako


#
# Scaling
#

#
# QT_SCALE_FACTOR with fractions such as 0.9, 1.5 results in blurry icons
#
env = QT_FONT_DPI, {{ (env_ethalon * env_scale) | round | int }}
env = GDK_DPI_SCALE, {{ env_scale }}
env = ELM_SCALE, {{ env_scale }}


#
# General settings
#
general {
    border_size = {{ space_normal }}
    gaps_in = {{ space_big }}
    gaps_out = {{ gaps }}
    # gaps_workspaces =

    col.active_border = {{ active }}
    col.nogroup_border_active = {{ active }}
    col.inactive_border = {{ inactive }}
    col.nogroup_border = {{ inactive }}

    layout = master

    resize_on_border = false
    # extend_border_grab_area =
    # hover_icon_on_border =

    no_focus_fallback = true
    no_border_on_floating = false
    allow_tearing = true
    resize_corner = 0

    # sensitivity = 1.0
    apply_sens_to_raw = false
}


#
# Look configuration.
#
decoration {
    rounding = 0
    active_opacity = 1.0
    inactive_opacity = 1.0
    fullscreen_opacity = 1.0

    drop_shadow = false
    # shadow_range =
    # shadow_render_power =
    # shadow_ignore_window =
    # col.shadow =
    # col.shadow_inactive =
    # shadow_offset
    # shadow_scale =

    dim_inactive = false
    # dim_strength = 0.5
    # dim_special = 0.9
    # dim_around = 0.5

    # screen_shader =

    blur {
        enabled = false
        # size =
        # passes =
        # ignore_opacity =
        # new_optimizations =
        # xray =
        # noise =
        # contrast =
        # brightness =
        # vibrancy =
        # vibrancy_darkness =
        # special =
        # popups =
        # popups_ignorealpha =
    }
}

animations {
    enabled = false
    first_launch_animation = false
}


#
# Input configuration.
#
{{- "\n" -}}
{%- for dev in [
    "usb-optical-mouse--keyboard",
    "usb-optical-mouse--keyboard-1",
    "sem-usb-keyboard-system-control",
    "sem-usb-keyboard-consumer-control-1",
    "power-button",
    "power-button-1",
] %}
device {
    name = "{{ dev }}"
    enabled = false
}
{% endfor -%}
{{- "\n" -}}

input {
    kb_model = pc104
    kb_layout = us,ru,ua
    kb_options = grp:menu_toggle,compose:rctrl,terminate:ctrl_alt_bksp
    # kb_variant =
    # kb_rules =
    # kb_file =

    numlock_by_default = true
    resolve_binds_by_sym = false
    repeat_rate = 25
    repeat_delay = 600

    accel_profile = flat
    sensitivity = -0.5
    force_no_accel = false
    left_handed = false

    scroll_factor = 1.0
    natural_scroll = false
    # scroll_points =
    # scroll_method =
    # scroll_button =
    # scroll_button_lock =
    # off_window_axis_events =
    # emulate_discrete_scroll =

    follow_mouse = 1
    mouse_refocus = true

    float_switch_override_focus = 2
    special_fallthrough = false 
}

#
# Groups configuration.
#
group {
    insert_after_current = true
    focus_removed_window = true

    col.border_active = {{ active }}
    col.border_locked_active = {{ active}}
    col.border_inactive = {{ inactive }}
    col.border_locked_inactive = {{ inactive }}

    groupbar {
        enabled = true

        gradients = true
        height = {{ font_size + space_normal * 2 }}

        font_family = {{ font }}
        font_size = {{ font_size }}

        text_color = {{ foreground }}
        col.active = {{ active }}
        col.locked_active = {{ active }}
        col.inactive = {{ inactive }}
        col.locked_inactive = {{ inactive }}

        render_titles = true
        stacked = false
        priority = 3
        scrolling = true
    }
}

#
# Misc configuration.
#
misc {
    disable_hyprland_logo = true
    disable_splash_rendering = true
    # col.splash =
    # splash_font_family =
    # force_default_wallpaper =

    font_family = {{ font }}
    background_color = {{ background }}
    animate_manual_resizes = false
    animate_mouse_windowdragging = false

    vfr = true
    vrr = 0
    mouse_move_enables_dpms = true
    key_press_enables_dpms = true

    always_follow_on_dnd = true
    layers_hog_keyboard_focus = true
    close_special_on_empty = false
    new_window_takes_over_fullscreen = 2
    # exit_window_retains_fullscreen =
    initial_workspace_tracking = 1
    middle_click_paste = true

    enable_swallow = true
    # swallow_regex = .*
    # swallow_exception_regex

    #?disable_autoreload = true
    focus_on_activate = false
    mouse_move_focuses_monitor = true

    render_ahead_of_time = false
    # render_ahead_safezone =
}

binds {
    pass_mouse_when_bound = false
    disable_keybind_grabbing = false

    # scroll_event_delay =

    workspace_back_and_forth = false 
    workspace_center_on = 0
    allow_workspace_cycles = true
    focus_preferred_method = 1
    window_direction_monitor_fallback = false

    ignore_group_lock = false
    movefocus_cycles_fullscreen = false
}

xwayland {
    use_nearest_neighbor = true
    force_zero_scaling = true
}

opengl {
    nvidia_anti_flicker = false
    force_introspection = 2
}

cursor {
    default_monitor = {{ (env_monitors | first).wayland }}

    no_hardware_cursors = false
    enable_hyprcursor = false
    # no_break_fs_vrr =
    # min_refresh_rate =
    # allow_dumb_copy
    # sync_gsettings_theme =

    hotspot_padding = 0
    inactive_timeout = 0
    hide_on_key_press = false
    hide_on_touch = false
    zoom_factor = 1.0
    zoom_rigid = false

    no_warps = true
    persistent_warps = false
    warp_on_change_workspace = false
}

debug {
    overlay = false
    disable_logs = true
    disable_time = true
    enable_stdout_logs = false
    colored_stdout_logs = true

    manual_crash = 0
    watchdog_timeout = 0
    suppress_errors = false

    disable_scale_checks = false
    error_position = 1
    # damage_tracking
}

master {
    allow_small_split = false
    special_scale_factor = 0.5
    mfact = 0.7
    new_status = slave
    new_on_top = true
    new_on_active = none
    no_gaps_when_only = 0
    orientation = center

    inherit_fullscreen = false
    always_center_master = false
    smart_resizing = true
    drop_at_cursor = true
}


#
# Keybinds.
#
bind = {{ alt }}, BackSpace, exit

bind = {{ mod }}, Q, closewindow, activewindow
bind = {{ alt }}, Q, killactive
bind = {{ mod }}, W, execr, kitty
bind = {{ mod }}, E, execr, rofi -show drun
bind = {{ alt }}, E, execr, rofi, -show windows
bind = {{ mod }}, R, togglespecialworkspace, scratch

bind = {{ mod }}, A, fullscreen, 1
bind = {{ mod }}, S, layoutmsg, orientationnext
bind = {{ alt }}, S, layoutmsg, rollnext
bind = {{ mod }}, D, togglefloating
bind = {{ alt }}, D, moveoutofgroup
bind = {{ mod }}, F, togglegroup

bind = {{ mod }}, Z, layoutmsg, swapwithmaster
#
# Master layout does not have:
#  X - tag window
#  V - move tagged window 
#  C - vertical split/swap
#  N - horizontal split/swap
#
bind = {{ alt }}, C, layoutmsg, swapnext
bind = {{ alt }}, N, layoutmsg, swapprev

bind = {{ mod }}, U, focusurgentorlast
bind = {{ alt }}, U, execr, makoctl restore
bind = {{ alt }}, O, exec, grim -g "$(slurp -d)" - | wl-copy
bind = {{ alt }}, O, exec, grim -g "$(slurp -d)" $(xdg-user-dir PICTURES)/shot-$(date +%s).png
bind = {{ mod }}, Y, execr, {{
    [
        "rofi"
            "-show", "drun",
            "-display-drun", "'drun (network namespaced)'",
            "-run-command", "'vopono exec -- {cmd}'",
    ] | join(" ")
}}
#
# Hyprland lacks:
#  P - pseudotitle in master layout
#  M - window minimizing/bringing
#

{{- "\n" -}}
{%- for direction, binds in {
    "l": ["Left", "H"],
    "d": ["Down", "J"],
    "u": ["Up", "K"],
    "r": ["Right", "L"],
}.items() -%}
    {%- for bind in binds -%}
        bind = {{ mod }}, {{ bind }}, movefocus, {{ direction }}{{- "\n" -}}
        bind = {{ alt }}, {{ bind }}, movewindoworgroup, {{ direction }}{{- "\n" -}}
    {%- endfor -%}
{%- endfor -%}
{{- "\n" -}}

bind = {{ mod }}, Escape, focusmonitor, +1
bind = {{ alt }}, Escape, focusmonitor, -1
bind = {{ mod }}, Tab, cyclenext, next tiled
bind = {{ alt }}, Tab, cyclenext, prev tiled
bind = {{ mod }}, Caps_Lock, changegroupactive, f
bind = {{ alt }}, Caps_Lock, changegroupactive, b

{{- "\n\n" -}}
{%- for direction in ["forward", "backwards"] -%}
    {%- set awk_total_ws = {"v": (env_monitors | first).workspaces} -%}
    {%- for mon in env_monitors | reverse -%}
        {%- if not loop.last -%}
            {%- set _ = awk_total_ws.update({
                "v": "f == \"{}\" ? {} : ({})".format(
                    mon.name[0].upper(), mon.workspaces, awk_total_ws.v,
                )
            }) -%}
        {%- endif -%}
    {%- endfor -%}

    {#
        next = (v - min + 1) % (max - min + 1) + min
        prev = (v - min - 1) % (max - min + 1) + min
        where non-negative modulo = (a % m + m) % m
    #}
    {%- set workspace_cmd = [
        "hyprctl dispatch workspace name:$(",
            "hyprctl activeworkspace -j | ",
            "jq --raw-output '.name' | ",
            "awk '{",
                "f = substr($0, 1, 1); ",
                "n = substr($0, (f ~ /^[0-9]+$/ ? 1 : 2)); ",
                "t = {}; ".format(awk_total_ws.v),
                "print {} {}".format(
                    "(f ~ /^[0-9]+$/ ? \"\" : f)",
                    "(n % t + 1)" if direction == "forward" else "(((n - 1 - 1) % t + t) % t + 1)",
                ),
            "}'",
        ")",
    ] | join -%}
    bind = {{ mod if direction == "forward" else alt }}, Grave, exec, {{ workspace_cmd }}{{- "\n" -}}
{%- endfor -%}
{{- "\n" -}}

{%- for i in range(5) -%}
    bind = {{ mod }}, {{ loop.index }}, changegroupactive, {{ loop.index }}{{- "\n" -}}
{%- endfor -%}
{{- "\n" -}}

{%- for mon in env_monitors -%}
    {%- set mon_index = loop.index0 -%}
    {%- for _ in range(mon.workspaces) -%}
        {%- set key = "F{}".format(monitors_keybind[mon_index][loop.index0]) -%}
        {%- set ws_name = "name:{}{}".format(
            "" if mon_index == 0 else mon.name[0].upper(),
            loop.index,
        ) -%}

        workspace = {{ ws_name }}, monitor:{{ mon.wayland }}, default:true{{- "\n" -}}
        bind = {{ mod }}, {{ key }}, workspace, {{ ws_name }}{{- "\n" -}}
        bind = {{ alt }}, {{ key }}, movetoworkspacesilent, {{ ws_name }}{{- "\n" -}}
    {%- endfor -%}
{%- endfor -%}
{{- "\n" -}}

bindm = {{ mod }}, mouse:272, movewindow
bindm = {{ mod }}, mouse:273, resizewindow
bind = {{ mod }}, mouse:275, changegroupactive, f
bind = {{ mod }}, mouse:276, changegroupactive, b

bind = , XF86AudioPlay, exec, playerctl play-pause
bind = , XF86AudioStop, exec, playerctl stop
bind = , XF86AudioPrev, exec, playerctl previous
bind = , XF86AudioNext, exec, playerctl next


#
# Rules.
#
windowrulev2 = suppressevent maximize, class:.*
windowrulev2 = float, title:^.*([Ii]nsert)|([Cc]opy)|([Ss]elect)|([Cc]onfirm)|([Pp]rogress)|([Aa]dd).*$
windowrulev2 = center, title:^.*([Ii]nsert)|([Cc]opy)|([Ss]elect)|([Cc]onfirm)|([Pp]rogress)|([Aa]dd).*$

windowrulev2 = immediate, fullscreen:1