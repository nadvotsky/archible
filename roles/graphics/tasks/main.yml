---
- name: Install proprietary nvidia graphics drivers
  tags:
    - graphics-driver
    - graphics-nvidia
  ansible.builtin.import_role:
    name: common
  vars:
    _common_packages:
      install:
        - nvidia
        - nvidia-utils
        - nvidia-settings
        - libva-nvidia-driver
    #
    # VA-API <-> NvDEC bridge
    #
    _common_environment:
      - key: LIBVA_DRIVER_NAME
        value: nvidia
      - key: NVD_BACKEND
        value: direct
      - key: __GL_ALLOW_UNOFFICIAL_PROTOCOL
        value: 1

- name: Configure ly login manager
  tags:
    - graphics-ly
    - graphics-login-manager
  ansible.builtin.import_role:
    name: common
  vars:
    _common_packages:
      install:
        - ly

    _common_install:
      defaults:
        become: true
        base: /etc
      targets:
        ly/config.ini:
          file: ly/config.ini
        ly/xsetup.sh:
          content: &minwm |
            #!/bin/sh
            [ -f /etc/profile ] && . /etc/profile
            exec "$@" >/dev/null
        ly/wsetup.sh:
          content: *minwm
        #
        # While making override.conf is possible, it is easier to simply replace
        # the entire service definition. It is likely not going to be updated on each update,
        # so no problem with .pacnew is expected.
        #
        /usr/lib/systemd/system/ly.service: |
          [Unit]
          Description=TUI display manager
          After=systemd-user-sessions.service plymouth-quit-wait.service
          After=getty@tty1.service
          Conflicts=getty@tty1.service

          [Service]
          Type=idle
          ExecStart=/usr/bin/ly-dm
          StandardInput=tty
          TTYPath=/dev/tty1
          TTYReset=yes
          TTYVHangup=yes

          [Install]
          Alias=display-manager.service

    _common_services:
      ly:
        enable: true
        reload: true

- name: Include look tasks
  tags:
    - graphics-look
  ansible.builtin.import_tasks:
    file: look.yml

- name: Configure XDG desktop portals
  tags:
    - graphics-portals
  block:
    - name: Install XDG desktop portals packages
      ansible.builtin.import_role:
        name: common
      vars:
        _common_packages:
          install:
            - xdg-desktop-portal
            - xdg-desktop-portal-gtk

    - name: Create highest precedence configuration directory for XDG desktop portals
      ansible.builtin.file:
        path: "{{ users.user.config }}/xdg-desktop-portal"
        state: directory
        mode: "0755"

- name: Import x11 related tasks
  tags:
    - graphics-x11
  ansible.builtin.import_tasks:
    file: x11.yml

- name: Import wayland related tasks
  tags:
    - graphics-wayland
  ansible.builtin.import_tasks:
    file: wayland.yml

- name: Configure rofi app launcher
  tags:
    - graphics-app-launcher
    - graphics-rofi
  ansible.builtin.import_role:
    name: common
  vars:
    _common_packages:
      install:
        - rofi-wayland
        - rofi-emoji-git
      remove:
        - rofi-emoji
    _common_install:
      targets:
        rofi/config.rasi:
          wipe: true
          template: rofi/config.rasi.j2
