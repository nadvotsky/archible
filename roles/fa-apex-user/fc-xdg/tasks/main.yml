---
- name: Configure base directories
  tags: apex-user-xdg-base
  block:
    - name: Create XDG base directories
      become: true
      foundation.files.install:
        wipe: never
        create: true
        perms: "755:644:{{ ca_name }}:{{ ca_name }}"
      vars:
        #
        # By default, ansible will create parent directories with default umask.
        # Because of that, using the lookup plugin to extract every directory, including intermediate ones.
        #
        targets: >-
          {{
            lookup('fa_homedirs', fa_dir_home, [fa_dir_config, fa_dir_cache, fa_dir_share, fa_dir_state, fa_dir_bin])
          }}

- name: Configure user directories
  tags: apex-user-xdg-dirs
  block:
    - name: Install XDG utilities
      foundation.system.packages:
      vars:
        install:
          - xdg-user-dirs
          - dex

    - name: Create XDG user directories
      foundation.files.install:
        wipe: never
        create: true
        perms: "755:644:{{ ca_name }}:{{ ca_name }}"
      vars:
        #
        # Extracting intermediate directories to not violate perms.
        #
        targets: "{{ query('fa_homedirs', fa_dir_home, fa_dir_xdg.values() | list) }}"

    - name: Reset XDG user dirs
      foundation.files.install:
        wipe: "{{ aa_wipe }}"
        base: "{{ fa_dir_config }}"
      vars:
        targets:
          - file: ./user-dirs.dirs
          - file: ./user-dirs.locale

    - name: Set XDG user directories via xdg-user-dirs
      ansible.builtin.command:
        argv:
          - xdg-user-dirs-update
          - --set
          - "{{ item.key | upper }}"
          - "{{ item.value }}"
      register: _fc_set_invocation
      changed_when: _fc_set_invocation.rc == 0
      loop: "{{ fa_dir_xdg | dict2items }}"

    - name: Run finalizing xdg-user-dirs-update
      ansible.builtin.command:
        argv:
          - xdg-user-dirs-update
      register: _fc_update_invocation
      changed_when: _fc_update_invocation.rc == 0

- name: Configure XDG mime applications
  tags: apex-user-xdg-mime
  block:
    - name: Install XDG Mime packages
      foundation.system.packages:
      vars:
        install:
          - desktop-file-utils

    - name: Reset XDG Mime Applications
      become: true
      foundation.files.install:
        wipe: "{{ aa_wipe }}"
      vars:
        targets:
          - file: "{{ fa_dir_config }}/mimeapps.list"
          - file: /usr/share/applications/mimeinfo.cache
          - file: /usr/local/share/applications/mimeinfo.cache

    - name: Update XDG desktop database
      become: true
      ansible.builtin.command:
        argv:
          - update-desktop-database
      register: _fc_database_invocation
      changed_when: _fc_database_invocation.rc == 0
