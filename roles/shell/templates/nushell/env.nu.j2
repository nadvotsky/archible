{%- set _spacing = " " -%}

{%- set _nu = preset | parse_ansi_presets(ansi, mod="light", sep="_") -%}
{%- set _nu_fixes = {
    "light_white": "light_gray",
    "light_black": "dark_gray",
} -%}

{%- macro _nu_icon_render_internal(_icon, _preset) -%}
    {{ _spacing }}(ansi {{ _nu_fixes.get(_preset, _preset) }}){{ _icon }}(ansi reset){{ _spacing }}{{ _spacing }}
{%- endmacro -%}

{%- macro _nu_icon_render(_icon, _preset) -%}
    {{ _nu_icon_render_internal("\\u{%s}" % _icon, _nu.get(_preset, _preset)) }}
{%- endmacro -%}


#
# Nushell Environment Config File
#
# based on the default config from 0.94.2
#

{% if ["shell-starship", "shell-prompt"] | is_tagged(ansible_run_tags, ansible_skip_tags) %}
#
# Starship prompt configuration.
#
if ($env.TERM | str starts-with "xterm") {
    $env.STARSHIP_LOG = "error"
    $env.STARSHIP_CACHE = "/tmp"
    $env.PROMPT_COMMAND = {||
        (
            ^starship prompt
            $"--cmd-duration=($env.CMD_DURATION_MS)"
            $"--status=($env.PROMPT_STATUS)"
        )
    }

    $env.PROMPT_COMMAND_RIGHT = ""
    $env.PROMPT_INDICATOR = ""

    $env.PROMPT_INDICATOR_VI_INSERT = {|| $"{{ _nu_icon_render("f17b5", _nu.sharp.line) }}" }
    $env.PROMPT_INDICATOR_VI_NORMAL = {|| $"{{ _nu_icon_render("f090c", _nu.sharp.line) }}" }
    $env.PROMPT_MULTILINE_INDICATOR = {|| $"{{ _nu_icon_render("ea7c", _nu.sharp.line) }}" }
}


{% endif %}
#
# Specifies how environment variables are:
#  - converted from a string to a value on Nushell startup (from_string)
#  - converted from a value back to a string when running external commands (to_string)
#
# Note: The conversions happen after config.nu is loaded.
#
$env.ENV_CONVERSIONS = {
    "PATH": {
        from_string: { |s| $s | split row (char esep) | path expand --no-symlink }
        to_string: { |v| $v | path expand --no-symlink | str join (char esep) }
    }
}


{% if ["user-gpg"] | is_tagged(ansible_run_tags, ansible_skip_tags) %}
#
# GnuPG SSH Agent configuration.
#
$env.GPG_TTY = (^tty)
$env.SSH_AUTH_SOCK = (gpgconf --list-dirs agent-ssh-socket)


{% endif %}
#
# Aliases.
#
alias l = ls -a
alias ee = sudoedit
{% if ["shell-fastfetch", "shell-fetch"] | is_tagged(ansible_run_tags, ansible_skip_tags) %}
alias ff = fastfetch
{% endif %}
